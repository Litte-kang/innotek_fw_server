var Mongoose = require('../db');
var Schema = Mongoose.Schema;

var schema = new Schema({
	myDeviceType:Number,
	addressName:String,
	myId:String,
	slaveDeviceType:Number,
	hostId:String,
	version:String,
	updateAt:String
});

var DevInfo = Mongoose.InnotekDevFwDb.model('device_infos', schema);

module.exports.setDevInfo = function(info, res)
{
	var json = JSON.parse(info);
	console.log(info);

	if (1 === json.isAdd)
	{
		var devInfo = new DevInfo(json.data);

		DevInfo.findOne({myId:json.data.myId}, function(err, data){

			if (err)
			{
				res.writeHead(404);
				res.write("添加失败");
				res.end();
			}
			else
			{
				if (null !== data)
				{
					res.writeHead(404);
					res.write(json.data.myId + "设备已存在");	
					res.end();
				}
				else
				{
					devInfo.save(function(err){

						if (err)
						{
							res.writeHead(404);
							res.write("添加失败");
						}
						else
						{
							res.writeHead(200);
							res.write("添加成功");			
						}

						res.end();
					});								
				}
			}
		});
	}	
	else
	{
		DevInfo.findOne({myId:json.data.myId}, function(err, data){

			if (err)
			{
				res.writeHead(404);
				res.write("删除失败");
				res.end();
			}
			else
			{
				if (null === data)
				{
					res.writeHead(404);
					res.write(json.data.myId + "设备不存在");	
					res.end();
				}
				else
				{
					DevInfo.remove({myId:json.data.myId}, function(err){

						if (err)
						{
							res.writeHead(404);
							res.write("删除失败");
						}
						else
						{
							res.writeHead(200);
							res.write("删除成功");			
						}

						res.end();
					});								
				}
			}
		});		
	}	
};

module.exports.getDevInfos = function(index, slaveDevType, res)
{
	var opt;

	if ('null' === slaveDevType)
	{
		opt = {myDeviceType:Number(index)};
	}
	else
	{
		opt = {myDeviceType:slaveDevType,hostId:index};
	}

	DevInfo.find(opt, function(err, infos){


		res.setHeader('Content-Type', 'application/string');

		if (err)
		{
			console.log("not exist device information");
			res.writeHead(404);
			res.write("[]");	
		}
		else
		{
			console.log(infos);
			res.writeHead(200);	
			res.write(JSON.stringify(infos));
		}

		res.end();
	});
};