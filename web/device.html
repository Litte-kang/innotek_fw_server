<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-cn" />
<link rel="stylesheet" href="../js/dist/themes/default/style.min.css" />
</head>
<body>

</br>
</br>
<div id="dev_info_table">
<input name="addButton" type="button" id="addButton" onClick="buttonEvt(this)" value="增加设备类型" />
<input name="delButton" type="button" id="delButton" onClick="buttonEvt(this)" value="删除设备类型" />
<div id="dev_type_table"></div>
</div>

<div id="msg_dialog">
	<div id="msg_dialog_title"></div></br>
	<table id="version_table" width="500">
		<input type="radio" name="version" onClick="Version='001'" />0.0.1 
		<input type="radio" name="version" onClick="Version='002'" />0.0.2
		<input type="radio" name="version" onClick="Version='003'" checked="checked" />0.0.3
		</br>
		</br>
	</table>
	<div align="right">
		<input name="okButton" type="button" id="okButton" onClick="buttonEvt(this)" value="确定" />
		<input name="cancelButton" type="button" id="cancelButton" onClick="buttonEvt(this)" value="取消" />
	</div>
</div>

<div id="display"></div>

<script src="js/my_http.js"></script>
<script type="text/javascript">

///*
var DeviceInfos;
var Version = "003";
var DevInfoCheckboxTrueSum 	= 0;
var Cmd 					= 0;

function updateAction()
{
	var i 			= 0;
	var slaveId 	= [];
	var hostId 		= 0;

	hostId = DeviceInfos[0]["hostId"];

	Cmd = '{"fwType":' + DeviceInfos[0]["myDeviceType"] + ',"hostId":"' + hostId + '","slaveId":[';

	for (i = 0; i < DeviceInfos.length; ++i)
	{
		var id;	
		
		id = "000" + i;
		id = id.substring(id.length - 3);

		if (document.getElementById(("dev_info_checkbox_" + id)).checked)
		{
			//slaveId.push(document.getElementById((id + "_001")).innerHTML);
			slaveId.push(('"' + DeviceInfos[i]["myId"] + '"'));
		}
	}

	Cmd = Cmd + slaveId + '],';

	document.getElementById("msg_dialog").style.display = "block";

	document.getElementById("display").innerHTML = Cmd;
}

function buttonEvt(btn)
{

	if ("addButton" == btn.id)
	{
		document.getElementById("display").innerHTML = "block dialog";
		document.getElementById("display").style.display = "block";
	}
	else if ("delButton" == btn.id)
	{
		alert("delButton");
	}
	else if ("updateButton" == btn.id)
	{
		if (0 < DevInfoCheckboxTrueSum)
		{
			updateAction();	
		}
		else
		{
			alert("请选择至少一台需要升级的设备");
		}
		
	}
	else if ("cancelButton" == btn.id)
	{
		document.getElementById("msg_dialog").style.display = "none";
	}
	else if ("okButton" == btn.id)
	{
		var res;

		document.getElementById("msg_dialog").style.display = "none";

		Cmd = Cmd + '"version":"' + Version + '"}';

		document.getElementById("display").innerHTML = Cmd;

		res = sendHttpReq("post", "db/update_fw_cmd", Cmd);

		alert("发送成功 "+res);
	}

}

function checkboxEvt(obj)
{
	var i = 0;

	document.getElementById("display").innerHTML = obj.id;

	if ("dev_info_checkbox_all" == obj.id)
	{
		DevInfoCheckboxTrueSum = obj.checked ? DeviceInfos.length : 0;

		for (i = 0; i < DeviceInfos.length; ++i)
		{
			var id;

			id = "000" + i;
			id = id.substring(id.length - 3);
			id = "dev_info_checkbox_" + id;

			document.getElementById(id).checked = obj.checked;
		}
	}
	else if (document.getElementById("dev_info_checkbox_all").checked)
	{
		document.getElementById("dev_info_checkbox_all").checked = false;
		DevInfoCheckboxTrueSum--;
	}
	else
	{
		if (obj.checked)
		{
			DevInfoCheckboxTrueSum++;

			if (DeviceInfos.length == DevInfoCheckboxTrueSum)
			{
				document.getElementById("dev_info_checkbox_all").checked = true;
			}
		}
		else
		{
			DevInfoCheckboxTrueSum--;
		}
	}

	document.getElementById("display").innerHTML = DevInfoCheckboxTrueSum;
}

function createDevInfoTable(xObj, evt, slaveDevType)
{
	var infoTable = '<table id="infoTable" width="1070" height="50" border="1" align="left" cellspacing="0" bordercolor="#000000">';
	var tableHeader = '<tr>' +
						'<td>&nbsp</td>' +
						'<td id="host_id"></td>' +
						'<td>&nbsp</td>' +
						'<td><input name="updateButton" type="button" id="updateButton" onClick="buttonEvt(this)" value="升级固件" /></td>' +
					 '</tr>' +
					 '<tr>' +
						'<td><input id="dev_info_checkbox_all" type="checkbox" onClick="checkboxEvt(this)"></td>' +
						'<td>ID:</td>' +
						'<td>Address:</td>' +
						'<td>Version:</td>' +
					 '</tr>';
	var tableHeaderSum = 0;
	var myTable = '';
	var i = 0;
	var valueIndex = 0;
	var url = '';

	valueIndex = xObj.id.substring(0, 4) + "001";
	url = "db/device_infos/" + document.getElementById(valueIndex).innerHTML + "?slaveDevType=" + slaveDevType;
	DeviceInfos = sendHttpReq("get", url, null);
	DeviceInfos = eval("(" + DeviceInfos + ")");

	if (0 != DeviceInfos.length)
	{
		myTable = infoTable + tableHeader;

		for (i = 0; i < DeviceInfos.length; ++i)
		{
			var htmls 	= '';
			var rowNum 	= "000";
			var id 		= "000_000";
			
			rowNum = rowNum + i;
			rowNum = rowNum.substring((rowNum.length - 3));

			id = rowNum + "_000";
			htmls = '<tr>' + 
					'<td id="' + id + '"><input id="dev_info_checkbox_' + rowNum + '" type="checkbox" onClick="checkboxEvt(this)"></td>';
			id = rowNum + "_001";
			htmls = htmls + '<td id="' + id + '" onClick="createDevInfoTable(this, arguments[0], ' + DeviceInfos[i]["slaveDeviceType"] + ')">' + DeviceInfos[i]["myId"] + '</td>';				
			id = rowNum + "_002";
			htmls =  htmls + '<td id="' + id + '">' + DeviceInfos[i]["addressName"] + '</td>';			
			id = rowNum + "_003";
			htmls = htmls + '<td id="' + id + '">' + DeviceInfos[i]["version"] + '</td>'; 
			htmls = htmls + '</tr>';

			myTable += htmls;

		}

		document.getElementById("dev_info_table").innerHTML = myTable;	
		document.getElementById("host_id").innerHTML = "Host ID:" + DeviceInfos[0]["hostId"];		
	}
	else
	{
		alert("no device information");
	}

	Version = "003";
	DevInfoCheckboxTrueSum 	= 0;
	Cmd = "";

}

function createDevTypeTable(params)
{
	var infoTable = '<table id="infoTable" width="1070" height="50" border="1" align="left" cellspacing="0" bordercolor="#000000">';
	var tableHeader = '<tr>';
	var tableHeaderSum = 0;
	var myTable = '';
	var i = 0;

	//-- create table header --//
	for(i = 0; i < params.tableHeader.length; ++i)
	{
		tableHeader = tableHeader + '<td>' + params.tableHeader[i] + '</td>';
	}
	tableHeader = tableHeader + '</tr>';

	myTable = infoTable + tableHeader;

	//-- create root node --//
	for (i = 0; i < params.rootNode.length; ++i)
	{
		var row = '';
		var id = "000"; //-- 000_000 --//
		
		id = id + i;
		id = id.substring((id.length - 3));

		row = '<tr>' +
				'<td id="' + id + '_000' + '" onClick="createDevInfoTable(this, arguments[0], null)">' + params.rootNode[i][0] + '</td>';				
		
		for (var n = 1; n < params.tableHeader.length; ++n)
		{
			var tmp = "000";

			tmp = tmp + n;
			tmp = tmp.substring(tmp.length - 3);
			tmp = '_' + tmp;

			row =  row + '<td id="' + id + tmp + '">' + params.rootNode[i][n] + '</td>';			
		}

		row = row + '</tr>';
		myTable += row;

	}
	
	document.getElementById("dev_type_table").innerHTML = myTable;	
}	

function loadDevTypesInfo()
{
	var tmp = '[{"deviceType":0,"deviceName":"自控仪"},{"deviceType":100,"deviceName":"物联网现场中间件"},{"deviceType":1,"deviceName":"插秧机"}]';
	var hostDevSum = 0;
	var tmpObj;
	var hostDeviceTypes = [];
	var i = 0;

	tmp = sendHttpReq("get", "db/device_types", null);

	tmpObj = eval("("+tmp+")");
	hostDevSum = tmpObj.length;

	if (0 != hostDevSum)
	{
		for (i = 0; i < hostDevSum; ++i)
		{
			var devType;

			devType = "000" + tmpObj[i]["deviceType"];
			devType = devType.substring(devType.length - 3);

			hostDeviceTypes.push([
				tmpObj[i]["deviceName"],
				devType,
			]);
		}

		createDevTypeTable({rootNode:hostDeviceTypes, id:"dev_type_table", tableHeader:["设备类型名称","设备类型编码"]});		
	}
	else
	{
		alert("no device");
	}	
}

function createMsgDialog(title)
{
	var bottom;
	var right;
	
	bottom = document.body.clientHeight / 2 + 50;
	right = document.body.clientWidth / 2 - 250;
	
	document.getElementById("msg_dialog_title").innerHTML = title;
	document.getElementById('msg_dialog_title').style.background = "#52CCCC";

    document.getElementById('msg_dialog').style.position = "absolute";
    document.getElementById('msg_dialog').style.background = "#4C6874";
    document.getElementById('msg_dialog').style.zIndex = "1112"
    document.getElementById('msg_dialog').style.bottom = bottom + "px";
    document.getElementById('msg_dialog').style.right = right + "px";

    document.getElementById("msg_dialog").style.display = "none";
}

function init()
{
	loadDevTypesInfo();

	createMsgDialog("请选则一个固件版本");
}

init();

</script>

</body>
</html>