<html>
<head>
<title>Upload</title>
</head>
<body>
 <!-- 用于文件上传的表单元素 --> 
<table id="fwInfoTable" width="800" height="50" border="1" align="left" cellspacing="0" bordercolor="#000000">
    <td width="800" height="100">
        </br>
        <textarea id="version_note" cols="100" rows="10"></textarea></br>
        <input type="radio" name="fw_type" onClick="Version='001'" />中间件 
        <input type="radio" name="fw_type" onClick="Version='002'" />自控仪
        <input type="radio" name="fw_type" onClick="Version='003'" checked="checked" />插秧机</br>
         <form name="demoForm" id="demoForm" method="post" enctype="multipart/form-data" 
 action="javascript: uploadAndSubmit();"> 
 <p>Upload File: <input type="file" name="file" /></p> 
 <p><input type="submit" value="Submit" /></p> 
 </form> 
 <div>Progessing (in Bytes): <span id="bytesRead"> 
 </span> / <span id="bytesTotal"></span> 
 </div>
    </td>
</table>
<script src="js/my_http.js"></script>
<script type="text/javascript">

function getChDate()
{
    var date = new Date();
    var tmp = '0000';
    var chDate = '';
    
    tmp = tmp + date.getFullYear();
    tmp = tmp.substring((tmp.length - 4)) + "年";
    chDate = tmp;
    tmp = "00";
    tmp = tmp + (date.getMonth() + 1);
    tmp = tmp.substring((tmp.length - 2)) + "月";
    chDate = chDate + tmp;
    tmp = "00";
    tmp = tmp + (date.getDate());
    tmp = tmp.substring((tmp.length - 2)) + "日 ";
    chDate = chDate + tmp;
    tmp = "00";
    tmp = tmp + (date.getHours());
    tmp = tmp.substring((tmp.length - 2)) + ":";
    chDate = chDate + tmp;
    tmp = "00";
    tmp = tmp + (date.getMinutes());
    tmp = tmp.substring((tmp.length - 2)) + " ";
    chDate = chDate + tmp;      
    tmp = "00";
    tmp = tmp + (date.getSeconds());
    tmp = tmp.substring((tmp.length - 2));
    chDate = chDate + tmp;  
    
    return chDate;  
}

function uploadAndSubmit()
{ 
     var form = document.forms["demoForm"]; 
     var fw_info = '';
     var date = getChDate();

     fw_info = '{"fwType":0' + ',"version":"001"' + ',"info":"' + document.getElementById("version_note").value + '"' + ',"createAt":"' + date + '"}';

     sendHttpReq("post", "/db/fw_info", fw_info);
        
     if (form["file"].files.length > 0) 
     { 
         // 寻找表单域中的 <input type="file" ... > 标签
         var file = form["file"].files[0]; 
         // try sending 
         var reader = new FileReader(); 

         reader.onloadstart = function(){ 
             // 这个事件在读取开始时触发
             console.log("onloadstart"); 
             document.getElementById("bytesTotal").textContent = file.size; 
         } 
 
         reader.onprogress = function(p){ 
             // 这个事件在读取进行中定时触发
             console.log("onprogress"); 
             document.getElementById("bytesRead").textContent = p.loaded; 
         } 

         reader.onload = function(){ 
            // 这个事件在读取成功结束后触发
            console.log("load complete"); 
         } 

        reader.onloadend = function(){ 
        
        // 这个事件在读取结束后，无论成功或者失败都会触发
             if (reader.error) 
             { 
                console.log(reader.error); 
             } 
             else 
             { 
                    document.getElementById("bytesRead").textContent = file.size; 
                    
                    // 构造 XMLHttpRequest 对象，发送文件 Binary 数据
                    var xhr = new XMLHttpRequest(); 
                    xhr.open(/* method */ "POST", 
                    /* target url */ "fw/" + file.name 
                    /*, async, default to true */); 
                    
                    xhr.overrideMimeType("application/octet-stream"); 
                    xhr.sendAsBinary(reader.result); 
                    
                    xhr.onreadystatechange = function(){ 
                    
                         if (xhr.readyState == 4)
                         { 
                             if (xhr.status == 200) 
                             { 
                                 console.log("upload complete"); 
                                 console.log("response: " + xhr.responseText); 
                             } 
                         } 
                    } 
                } 
        } 

        reader.readAsBinaryString(file); 
     } //-- if (form["file"].files.length > 0)  --//
     else 
     { 
        alert ("Please choose a file."); 
     } 
}

</script>

</body>
</html>
