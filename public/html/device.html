<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="zh-cn" />
<link rel="stylesheet" href="../js/dist/themes/default/style.min.css" />
</head>
<body>

</br>
</br>
<div id="dev_info_table">
<input name="addButton" type="button" id="addButton" onClick="buttonEvt(this)" value="增加设备类型" />
<input name="delButton" type="button" id="delButton" onClick="buttonEvt(this)" value="删除设备类型" />
<div id="dev_type_table"></div>
</div>

<div id="display"></div>
<script type="text/javascript">

///*
var DeviceInfos;
var DevInfoCheckboxTrueSum = 0;

function createXmlHttpRequest()
{
	if (window.ActiveXObject)
	{
		return new ActiveXObject("Microsoft.XMLHTTP");
	}
	else if (window.XMLHttpRequest)
	{
		return new XMLHttpRequest();
	}
}

function sendHttpReq(method, url, data)
{
	var http_request = createXmlHttpRequest();
		
	http_request.open(method, url, false);
	http_request.setRequestHeader('Content-Type', 'text/plain');
	http_request.send(data);
	
	return http_request.responseText;
}

function buttonEvt(btn)
{

	if ("addButton" == btn.id)
	{
		document.getElementById("display").innerHTML = "block dialog";
		document.getElementById("display").style.display = "block";
	}
	else if ("delButton" == btn.id)
	{
		alert("delButton");
	}
	else if ("updateButton" == btn.id)
	{
		updateAction();
	}
}
function updateAction()
{
	var i = 0;
	var tmp = '';

	for (i = 0; i < DeviceInfos.length; ++i)
	{
		var id;	
		
		id = "000" + i;
		id = id.substring(id.length - 3);

		if (document.getElementById(("dev_info_checkbox_" + id)).checked)
		{
			tmp = tmp + document.getElementById((id + "_001")).innerHTML + " ";
		}
	}

	document.getElementById("display").innerHTML = tmp;
}

function checkboxEvt(obj)
{
	var i = 0;

	document.getElementById("display").innerHTML = obj.id;

	if ("dev_info_checkbox_all" == obj.id)
	{
		DevInfoCheckboxTrueSum = obj.checked ? DeviceInfos.length : 0;

		for (i = 0; i < DeviceInfos.length; ++i)
		{
			var id;

			id = "000" + i;
			id = id.substring(id.length - 3);
			id = "dev_info_checkbox_" + id;

			document.getElementById(id).checked = obj.checked;
		}
	}
	else if (document.getElementById("dev_info_checkbox_all").checked)
	{
		document.getElementById("dev_info_checkbox_all").checked = false;
		DevInfoCheckboxTrueSum--;
	}
	else
	{
		if (obj.checked)
		{
			DevInfoCheckboxTrueSum++;

			if (DeviceInfos.length == DevInfoCheckboxTrueSum)
			{
				document.getElementById("dev_info_checkbox_all").checked = true;
			}
		}
		else
		{
			DevInfoCheckboxTrueSum--;
		}
	}

	document.getElementById("display").innerHTML = DevInfoCheckboxTrueSum;
}

function createDevInfoTable(xObj, evt, slaveDevType)
{
	var infoTable = '<table id="infoTable" width="1070" height="50" border="1" align="left" cellspacing="0" bordercolor="#000000">';
	var tableHeader = '<tr>' +
						'<td>&nbsp</td>' +
						'<td id="host_id"></td>' +
						'<td>&nbsp</td>' +
						'<td><input name="updateButton" type="button" id="updateButton" onClick="buttonEvt(this)" value="升级固件" /></td>' +
					 '</tr>' +
					 '<tr>' +
						'<td><input id="dev_info_checkbox_all" type="checkbox" onClick="checkboxEvt(this)"></td>' +
						'<td>ID:</td>' +
						'<td>Address:</td>' +
						'<td>Version:</td>' +
					 '</tr>';
	var tableHeaderSum = 0;
	var myTable = '';
	var i = 0;
	var valueIndex = 0;
	var url = '';

	valueIndex = xObj.id.substring(0, 4) + "001";
	url = "device_infos/" + document.getElementById(valueIndex).innerHTML + "?slaveDevType=" + slaveDevType;
	DeviceInfos = sendHttpReq("get", url, null);
	DeviceInfos = eval("(" + DeviceInfos + ")");

	if (0 != DeviceInfos.length)
	{
		myTable = infoTable + tableHeader;

		for (i = 0; i < DeviceInfos.length; ++i)
		{
			var htmls 	= '';
			var rowNum 	= "000";
			var id 		= "000_000";
			
			rowNum = rowNum + i;
			rowNum = rowNum.substring((rowNum.length - 3));

			id = rowNum + "_000";
			htmls = '<tr>' + 
					'<td id="' + id + '"><input id="dev_info_checkbox_' + rowNum + '" type="checkbox" onClick="checkboxEvt(this)"></td>';
			id = rowNum + "_001";
			htmls = htmls + '<td id="' + id + '" onClick="createDevInfoTable(this, arguments[0], ' + DeviceInfos[i]["slaveDeviceType"] + ')">' + DeviceInfos[i]["myId"] + '</td>';				
			id = rowNum + "_002";
			htmls =  htmls + '<td id="' + id + '">' + DeviceInfos[i]["addressName"] + '</td>';			
			id = rowNum + "_003";
			htmls = htmls + '<td id="' + id + '">' + DeviceInfos[i]["version"] + '</td>'; 
			htmls = htmls + '</tr>';

			myTable += htmls;

		}

		document.getElementById("dev_info_table").innerHTML = myTable;	
		document.getElementById("host_id").innerHTML = "Host ID:" + DeviceInfos[0]["hostId"];		
	}
	else
	{
		alert("no device information");
	}

}

function createDevTypeTable(params)
{
	var infoTable = '<table id="infoTable" width="1070" height="50" border="1" align="left" cellspacing="0" bordercolor="#000000">';
	var tableHeader = '<tr>';
	var tableHeaderSum = 0;
	var myTable = '';
	var i = 0;

	//-- create table header --//
	for(i = 0; i < params.tableHeader.length; ++i)
	{
		tableHeader = tableHeader + '<td>' + params.tableHeader[i] + '</td>';
	}
	tableHeader = tableHeader + '</tr>';

	myTable = infoTable + tableHeader;

	//-- create root node --//
	for (i = 0; i < params.rootNode.length; ++i)
	{
		var row = '';
		var id = "000"; //-- 000_000 --//
		
		id = id + i;
		id = id.substring((id.length - 3));

		row = '<tr>' +
				'<td id="' + id + '_000' + '" onClick="createDevInfoTable(this, arguments[0], null)">' + params.rootNode[i][0] + '</td>';				
		
		for (var n = 1; n < params.tableHeader.length; ++n)
		{
			var tmp = "000";

			tmp = tmp + n;
			tmp = tmp.substring(tmp.length - 3);
			tmp = '_' + tmp;

			row =  row + '<td id="' + id + tmp + '">' + params.rootNode[i][n] + '</td>';			
		}

		row = row + '</tr>';
		myTable += row;

	}
	
	document.getElementById("dev_type_table").innerHTML = myTable;	
}	


function init()
{
	var tmp = '[{"deviceType":0,"deviceName":"自控仪"},{"deviceType":100,"deviceName":"物联网现场中间件"},{"deviceType":1,"deviceName":"插秧机"}]';
	var hostDevSum = 0;
	var tmpObj;
	var hostDeviceTypes = [];
	var i = 0;

	tmp = sendHttpReq("get", "device_types", null);

	tmpObj = eval("("+tmp+")");
	hostDevSum = tmpObj.length;

	if (0 != hostDevSum)
	{
		for (i = 0; i < hostDevSum; ++i)
		{
			var devType;

			devType = "000" + tmpObj[i]["deviceType"];
			devType = devType.substring(devType.length - 3);

			hostDeviceTypes.push([
				tmpObj[i]["deviceName"],
				devType,
			]);
		}

		createDevTypeTable({rootNode:hostDeviceTypes, id:"dev_type_table", tableHeader:["设备类型名称","设备类型编码"]});		
	}
	else
	{
		alert("no device");
	}
}

init();

</script>

</body>
</html>